name: Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # 1. 源码包构建
  build-sdist:
    name: build sdist
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: build sdist
        uses: PyO3/maturin-action@v1
        with:
          command: sdist
          args: --out dist
      - name: upload sdist
        uses: actions/upload-artifact@v4
        with:
          name: files-sdist
          path: dist

  # 2. 二进制 Wheels 构建 (参考 Pydantic 工业级矩阵)
  build-wheels:
    name: build on ${{ matrix.os }} (${{ matrix.target }} - ${{ matrix.interpreter || 'all' }}${{ matrix.os == 'linux' && format(' - {0}', matrix.manylinux == 'auto' && 'manylinux' || matrix.manylinux) || '' }})
    strategy:
      fail-fast: false
      matrix:
        os: [linux, macos, windows]
        target: [undefined]
        manylinux: [auto]
        include:
          # --- Linux manylinux ---
          - os: linux
            manylinux: auto
            target: x86_64
          - os: linux
            manylinux: auto
            target: aarch64
          - os: linux
            manylinux: auto
            target: i686

          # --- Linux musllinux (Alpine) ---
          - os: linux
            manylinux: musllinux_1_1
            target: x86_64
          - os: linux
            manylinux: musllinux_1_1
            target: aarch64

          # --- macOS ---
          - os: macos
            target: x86_64
          - os: macos
            target: aarch64

          # --- Windows ---
          - os: windows
            target: x86_64
          - os: windows
            target: i686
            python-architecture: x86
            # 32位环境通常需要显式指定解释器以避免混淆
            interpreter: 3.10 3.11 3.12 3.13

        exclude:
          - target: undefined

    runs-on: ${{ (matrix.os == 'linux' && 'ubuntu-latest') || (matrix.os == 'macos' && 'macos-latest') || (matrix.os == 'windows' && 'windows-latest') }}
    steps:
      - uses: actions/checkout@v4

      - name: set up python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          architecture: ${{ matrix.python-architecture || 'x64' }}

      - name: install tools
        run: pip install -U twine typing_extensions

      - name: build wheels
        uses: PyO3/maturin-action@v1
        with:
          target: ${{ matrix.target }}
          manylinux: ${{ matrix.manylinux }}
          # 显式覆盖支持的 Python 版本
          args: --release --out dist --interpreter ${{ matrix.interpreter || '3.10 3.11 3.12 3.13' }}
          sccache: "true"

      - name: check artifacts
        shell: bash
        run: |
          if [ "${{ matrix.os }}" = "windows" ]; then
            ls -lh dist/
          else
            ls -lh dist/
          fi
          twine check --strict dist/*

      - name: upload wheels
        uses: actions/upload-artifact@v4
        with:
          name: files_${{ matrix.os }}_${{ matrix.target }}_${{ matrix.interpreter || 'all' }}_${{ matrix.manylinux }}
          path: dist

  # 3. 文档部署
  build-docs:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: install uv
        uses: astral-sh/setup-uv@v7
      - name: build docs
        run: |
          uv sync --group docs
          uv run mkdocs build
      - name: upload docs
        uses: actions/upload-pages-artifact@v4
        with:
          path: ./site

  # 4. 汇总发布
  publish-pypi:
    name: publish to pypi
    runs-on: ubuntu-latest
    needs: [build-wheels, build-sdist]
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      id-token: write
    steps:
      - uses: actions/checkout@v4
      - name: verify tag matches package version
        shell: bash
        run: |
          TAG_VERSION="${GITHUB_REF_NAME#v}"
          PYPROJECT_VERSION="$(grep -m1 '^version = ' pyproject.toml | cut -d '"' -f2)"
          if [ "$TAG_VERSION" != "$PYPROJECT_VERSION" ]; then
            echo "Tag version ($TAG_VERSION) does not match pyproject version ($PYPROJECT_VERSION)"
            exit 1
          fi
      - name: download all artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: files*
          path: dist
          merge-multiple: true
      - name: publish to pypi
        uses: pypa/gh-action-pypi-publish@release/v1

  release:
    name: release
    runs-on: ubuntu-latest
    needs: [build-wheels, build-sdist, publish-pypi]
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: generate changelog
        uses: orhun/git-cliff-action@v4
        id: git-cliff
        with:
          args: -vv --latest --strip all

      - name: create release
        uses: softprops/action-gh-release@v2
        with:
          body: ${{ steps.git-cliff.outputs.content }}
          make_latest: true
          generate_release_notes: false

  # 5. 部署文档
  deploy-docs:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: [build-docs, build-wheels, build-sdist, publish-pypi, release]
    steps:
      - name: deploy
        id: deployment
        uses: actions/deploy-pages@v4
